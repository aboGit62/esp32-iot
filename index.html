<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart IoT Dashboard</title>

<!-- MQTT & Chart -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg1:#0f2027;
  --bg2:#203a43;
  --bg3:#2c5364;
  --glass:rgba(255,255,255,0.08);
  --accent:#00f2fe;
  --ok:#2ecc71;
  --alert:#ff4757;
}

*{box-sizing:border-box}

body{
  margin:0;
  height:100vh;
  font-family:'Poppins',sans-serif;
  background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3));
  display:flex;
  justify-content:center;
  align-items:center;
  color:white;
}

.dashboard{
  width:480px;
  padding:30px;
  border-radius:26px;
  background:var(--glass);
  backdrop-filter:blur(18px);
  box-shadow:0 0 60px rgba(0,0,0,0.8);
}

h1{
  text-align:center;
  margin:0;
  font-weight:800;
}

.subtitle{
  text-align:center;
  font-size:13px;
  opacity:.7;
  margin-bottom:25px;
}

.cards{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:18px;
}

.card{
  padding:18px;
  border-radius:18px;
  background:rgba(255,255,255,0.06);
  text-align:center;
}

.value{
  font-size:36px;
  font-weight:700;
}

.unit{
  font-size:13px;
  opacity:.7;
}

.status{
  margin-top:20px;
  padding:16px;
  border-radius:16px;
  text-align:center;
  font-weight:700;
}

.status.ok{
  background:rgba(46,204,113,0.2);
  color:var(--ok);
}

.status.alert{
  background:rgba(255,71,87,0.25);
  color:var(--alert);
  animation:pulse 1s infinite;
}

@keyframes pulse{
  0%{transform:scale(1)}
  50%{transform:scale(1.05)}
  100%{transform:scale(1)}
}

.controls{
  margin-top:22px;
}

.controls label{
  font-size:13px;
}

input[type=range]{
  width:100%;
}

.buttons{
  display:flex;
  gap:12px;
  margin-top:15px;
}

button{
  flex:1;
  padding:14px;
  border:none;
  border-radius:14px;
  font-weight:700;
  cursor:pointer;
}

.on{background:#2ecc71;color:white}
.off{background:#ff4757;color:white}

canvas{
  margin-top:25px;
}

footer{
  margin-top:20px;
  text-align:center;
  font-size:11px;
  opacity:.6;
}
</style>
</head>

<body>

<div class="dashboard">
  <h1>üåê Smart IoT</h1>
  <div class="subtitle">ESP32 ‚Ä¢ LDR ‚Ä¢ MQTT ‚Ä¢ Temps r√©el</div>

  <div class="cards">
    <div class="card">
      <div class="value" id="lux">---</div>
      <div class="unit">Luminosit√©</div>
    </div>

    <div class="card">
      <div class="value" id="etatTxt">---</div>
      <div class="unit">√âtat</div>
    </div>
  </div>

  <div class="status ok" id="status">SYST√àME NORMAL</div>

  <div class="controls">
    <label>üéõÔ∏è Seuil luminosit√© : <b><span id="seuilVal">1500</span></b></label>
    <input type="range" min="0" max="4095" value="1500"
           oninput="setSeuil(this.value)">
  </div>

  <div class="buttons">
    <button class="on" onclick="setAlerte('ON')">üîî Activer alerte</button>
    <button class="off" onclick="setAlerte('OFF')">üîï D√©sactiver alerte</button>
  </div>

  <canvas id="graph" height="120"></canvas>

  <footer>
    Projet IoT ‚Äì Dashboard temps r√©el
  </footer>
</div>

<script>
// ===== MQTT =====
const client = mqtt.connect(
  "wss://7083dd98527749e88e4f3bfece75ea0a.s1.eu.hivemq.cloud:8884/mqtt",
  { username:"esp32", password:"Esp32mqtt" }
);

client.on("connect", ()=>{
  client.subscribe("maison/luminosite");
  client.subscribe("maison/etat");
});

// ===== COMMANDES =====
function setAlerte(val){
  client.publish("maison/controle", val);
}

function setSeuil(val){
  document.getElementById("seuilVal").innerText = val;
  client.publish("maison/seuil", val.toString());
}

// ===== GRAPH =====
const ctx = document.getElementById("graph");
const chart = new Chart(ctx,{
  type:"line",
  data:{
    labels:[],
    datasets:[{
      label:"Luminosit√©",
      data:[],
      borderColor:"#00f2fe",
      tension:0.4
    }]
  },
  options:{
    animation:false,
    scales:{y:{min:0,max:4095}}
  }
});

// ===== MQTT DATA =====
client.on("message",(topic,message)=>{
  const msg = message.toString();

  if(topic==="maison/luminosite"){
    const v = parseInt(msg);
    document.getElementById("lux").innerText = v;

    chart.data.labels.push("");
    chart.data.datasets[0].data.push(v);
    if(chart.data.labels.length>30){
      chart.data.labels.shift();
      chart.data.datasets[0].data.shift();
    }
    chart.update();
  }

  if(topic==="maison/etat"){
    const st = document.getElementById("status");
    const txt = document.getElementById("etatTxt");

    if(msg.includes("NUIT")){
      txt.innerText="NUIT";
      st.className="status alert";
      st.innerText="OBSCURIT√â";
    }else{
      txt.innerText="JOUR";
      st.className="status ok";
      st.innerText="LUMI√àRE OK";
    }
  }
});
</script>

</body>
</html>